# Vector configuration for policy scaling benchmark

data_dir: "/Users/jea/Code/tero/edge/bench/scaling/data"

sources:
  otlp_source:
    type: http_server
    address: "127.0.0.1:4320"
    decoding:
      codec: json
    path: "/v1/logs"

  datadog_source:
    type: http_server
    address: "127.0.0.1:4321"
    decoding:
      codec: json
    path: "/api/v2/logs"

transforms:
  filter_0:
    type: filter
    inputs:
      - otlp_source
    condition: "!match(to_string(.message) ?? \"\", r'authentication')"

  filter_1:
    type: filter
    inputs:
      - filter_0
    condition: "!match(to_string(.message) ?? \"\", r'Payment')"

  filter_2:
    type: filter
    inputs:
      - filter_1
    condition: "!match(to_string(.message) ?? \"\", r'Cache miss')"

  filter_3:
    type: filter
    inputs:
      - filter_2
    condition: "!match(to_string(.message) ?? \"\", r'Cache hit')"

  filter_4:
    type: filter
    inputs:
      - filter_3
    condition: "!match(to_string(.message) ?? \"\", r'error')"

  filter_5:
    type: filter
    inputs:
      - filter_4
    condition: "!match(to_string(.message) ?? \"\", r'ERROR')"

  filter_6:
    type: filter
    inputs:
      - filter_5
    condition: "!match(to_string(.message) ?? \"\", r'debug')"

  filter_7:
    type: filter
    inputs:
      - filter_6
    condition: "!match(to_string(.message) ?? \"\", r'DEBUG')"

  filter_8:
    type: filter
    inputs:
      - filter_7
    condition: "!match(to_string(.message) ?? \"\", r'HTTP request')"

  filter_9:
    type: filter
    inputs:
      - filter_8
    condition: "!match(to_string(.message) ?? \"\", r'API call')"

  sample_logs:
    type: sample
    inputs:
      - filter_9
    ratio: 0.28

  throttle_logs:
    type: throttle
    inputs:
      - sample_logs
    threshold: 1000
    window_secs: 1

  dd_filter_0:
    type: filter
    inputs:
      - datadog_source
    condition: "!match(to_string(.message) ?? \"\", r'authentication')"

  dd_filter_1:
    type: filter
    inputs:
      - dd_filter_0
    condition: "!match(to_string(.message) ?? \"\", r'Payment')"

  dd_filter_2:
    type: filter
    inputs:
      - dd_filter_1
    condition: "!match(to_string(.message) ?? \"\", r'Cache miss')"

  dd_filter_3:
    type: filter
    inputs:
      - dd_filter_2
    condition: "!match(to_string(.message) ?? \"\", r'Cache hit')"

  dd_filter_4:
    type: filter
    inputs:
      - dd_filter_3
    condition: "!match(to_string(.message) ?? \"\", r'error')"

  dd_filter_5:
    type: filter
    inputs:
      - dd_filter_4
    condition: "!match(to_string(.message) ?? \"\", r'ERROR')"

  dd_filter_6:
    type: filter
    inputs:
      - dd_filter_5
    condition: "!match(to_string(.message) ?? \"\", r'debug')"

  dd_filter_7:
    type: filter
    inputs:
      - dd_filter_6
    condition: "!match(to_string(.message) ?? \"\", r'DEBUG')"

  dd_filter_8:
    type: filter
    inputs:
      - dd_filter_7
    condition: "!match(to_string(.message) ?? \"\", r'HTTP request')"

  dd_filter_9:
    type: filter
    inputs:
      - dd_filter_8
    condition: "!match(to_string(.message) ?? \"\", r'API call')"

  dd_sample_logs:
    type: sample
    inputs:
      - dd_filter_9
    ratio: 0.28

  dd_throttle_logs:
    type: throttle
    inputs:
      - dd_sample_logs
    threshold: 1000
    window_secs: 1

sinks:
  otlp_out:
    type: http
    inputs:
      - throttle_logs
    uri: "http://127.0.0.1:9999/v1/logs"
    method: post
    encoding:
      codec: json

  datadog_out:
    type: http
    inputs:
      - dd_throttle_logs
    uri: "http://127.0.0.1:9999/api/v2/logs"
    method: post
    encoding:
      codec: json
