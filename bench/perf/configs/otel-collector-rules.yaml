receivers:
  # Datadog receiver - receives Datadog format logs
  datadog:
    endpoint: 127.0.0.1:8080
    read_timeout: 60s

  # OTLP receiver - receives OTLP format logs
  otlp:
    protocols:
      http:
        endpoint: 127.0.0.1:8081

processors:
  # Minimal batching for benchmarks - send data quickly
  batch:
    send_batch_size: 10000

  # Filter processor - equivalent to policies.json drop rules
  # Note: filter processor drops matching logs (no "keep" action, only exclude)
  filter:
    error_mode: ignore
    logs:
      log_record:
        # drop-debug-logs: Drop debug level logs
        - 'severity_text == "DEBUG" or severity_text == "debug"'
        # drop-health-checks: Drop health check logs
        - 'IsMatch(body, ".*/health.*")'
        - 'IsMatch(body, ".*/ready.*")'
        - 'IsMatch(body, ".*/live.*")'
        # drop-database-queries: Drop database query logs
        - 'IsMatch(body, ".*Database query executed.*")'
        # drop-first-entry: Drop first log entry in 1MB payloads
        - 'IsMatch(body, ".*Log entry 0:.*")'

  # Transform processor - equivalent to policies.json transform rules
  transform:
    error_mode: ignore
    log_statements:
      - context: log
        statements:
          # redact-sensitive-data: Redact sensitive fields from payment logs
          - set(attributes["credit_card"], "[REDACTED]") where IsMatch(body, ".*payment.*") and attributes["credit_card"] != nil
          - set(attributes["ssn"], "[REDACTED]") where IsMatch(body, ".*payment.*") and attributes["ssn"] != nil

          # enrich-auth-logs: Add metadata to authentication logs
          - set(attributes["security_category"], "auth") where IsMatch(body, ".*(authentication|login).*")
          - set(attributes["compliance_required"], "true") where IsMatch(body, ".*(authentication|login).*")

          # normalize-api-logs: Normalize API request logs (rename http_method -> method, http_path -> path)
          - set(attributes["method"], attributes["http_method"]) where IsMatch(body, ".*(HTTP request|API call).*") and attributes["http_method"] != nil
          - delete_key(attributes, "http_method") where IsMatch(body, ".*(HTTP request|API call).*") and attributes["method"] != nil
          - set(attributes["path"], attributes["http_path"]) where IsMatch(body, ".*(HTTP request|API call).*") and attributes["http_path"] != nil
          - delete_key(attributes, "http_path") where IsMatch(body, ".*(HTTP request|API call).*") and attributes["path"] != nil
          - delete_key(attributes, "internal_trace_id") where IsMatch(body, ".*(HTTP request|API call).*")

          # drop-and-transform-cache: Add sampled flag to cache logs (sampling done by filter)
          - set(attributes["sampled"], "true") where IsMatch(body, ".*(cache hit|cache miss).*")
          - delete_key(attributes, "cache_key") where IsMatch(body, ".*(cache hit|cache miss).*")
          - delete_key(attributes, "cache_ttl") where IsMatch(body, ".*(cache hit|cache miss).*")

exporters:
  # Debug exporter for logging
  debug:
    verbosity: basic

  # Datadog exporter - sends to echo server
  datadog:
    host_metadata:
      enabled: false
    api:
      key: "xxxxxxxxxxxxx"
      site: "us5.datadoghq.com"
    logs:
      endpoint: "http://127.0.0.1:9999"

  # OTLP HTTP exporter - sends to echo server
  otlphttp:
    endpoint: http://127.0.0.1:9999
    compression: none

service:
  telemetry:
    logs:
      level: info
  pipelines:
    logs/datadog:
      receivers: [datadog]
      processors: [filter, transform, batch]
      exporters: [datadog, debug]
    logs/otlp:
      receivers: [otlp]
      processors: [filter, transform, batch]
      exporters: [otlphttp, debug]
